<script>
    window.onload = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            try {
                // Faz a solicitação para a função serverless de validação
                const response = await fetch(`/.netlify/functions/validate-oauth?code=${code}`);
                const data = await response.json();

                if (response.ok && data.access_token) {
                    // Se a validação for bem-sucedida, armazena o token no sessionStorage
                    sessionStorage.setItem('authToken', data.access_token);

                    // Solicita as informações do usuário
                    const userInfoResponse = await fetch('/.netlify/functions/user-info', {
                        headers: { 'Authorization': `Bearer ${data.access_token}` }
                    });
                    const userInfo = await userInfoResponse.json();

                    // Armazena informações do usuário
                    sessionStorage.setItem('userId', userInfo.id);
                    sessionStorage.setItem('username', userInfo.username);
                    sessionStorage.setItem('avatar', userInfo.avatar);

                    // Log para verificar as informações armazenadas
                    console.log('User ID:', sessionStorage.getItem('userId'));
                    console.log('Username:', sessionStorage.getItem('username'));
                    console.log('Avatar:', sessionStorage.getItem('avatar'));

                    // Redireciona para a página protegida
                    window.location.href = '/protected.html';
                } else {
                    // Se o código não for válido, redireciona para a página inicial
                    alert('Código inválido. Redirecionando...');
                    window.location.href = '/';
                }
            } catch (error) {
                // Em caso de erro no backend, redireciona para a página inicial
                alert('Erro na validação. Redirecionando...');
                window.location.href = '/';
            }
        } else {
            // Redireciona para a página inicial se não houver código
            window.location.href = '/';
        }
    };
</script>